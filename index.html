<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Controle de Gastos — Excel Model</title>
  <link rel="stylesheet" href="style.css"/>
  <style>
    /* Deixa selects do formulário de venda com texto amarelo */
    select[id^="sell-"] {
      color: #FFD54F !important;
    }
    /* Pequeno estilo para o painel de pré-cálculo dentro do form de venda */
    .imp3d-sell-preview {
      margin-top: 8px;
      padding: 8px;
      border-radius: 8px;
      background: rgba(255, 231, 163, 0.08);
      border: 1px solid rgba(255,215,64,0.08);
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
    }
    .imp3d-sell-preview div { min-width:140px; font-size:0.95rem; }
    .imp3d-sell-preview .label { color:var(--muted); font-size:0.78rem; display:block; }
    .imp3d-sell-preview .value { font-weight:700; margin-top:4px; }
    /* garante contraste no select (caso o tema escuro coloque fundo escuro) */
    select[id^="sell-"] option { color: #000; } /* opções internas continuam legíveis */
  </style>
</head>
<body>
  <header class="title">
    <h1>Controle de Gastos</h1>
    <p class="muted">Visão mensal de saldo, crédito global, VR e investimentos</p>
  </header>

  <div class="month-incrementer">
    <button id="prev-month" class="pill-btn">&lt;</button>
    <div class="month-display">
      <span class="month-caption">Índice do mês</span>
      <span id="month-index" class="month-index">0</span>
      <span id="month-label" class="month-label"></span>
    </div>
    <button id="next-month" class="pill-btn">&gt;</button>
  </div>

  <nav class="tabs">
    <button data-tab="dashboard" class="tab-btn active">Dashboard</button>
    <button data-tab="input" class="tab-btn">Input</button>
    <button data-tab="inicio" class="tab-btn">Início do mês</button>
    <button data-tab="invest" class="tab-btn">Investimentos</button>
    <button data-tab="log" class="tab-btn">Log</button>
    <button data-tab="imp3d" class="tab-btn">Impressora3D</button>
  </nav>

  <main class="wrap">
    <!-- DASHBOARD -->
    <section id="tab-dashboard" class="tab-panel active panel">
      <div class="panel-section">
        <h2 class="panel-title">Contas e resumo</h2>
        <div class="panel-grid">
          <div class="panel-card panel-card-full">
            <table class="accounts-table">
              <thead>
                <tr>
                  <th>Conta</th>
                  <th>Saldo</th>
                  <th>Gasto crédito (mês)</th>
                  <th>Gasto VR (mês)</th>
                  <th>Guardado</th>
                </tr>
              </thead>
              <tbody id="accounts-body"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="panel-section">
        <div class="panel-grid">
          <div class="panel-card">
            <h3 class="card-title">Crédito por conta (mês)</h3>
            <div class="chart-wrapper">
              <canvas id="gasto-credito-chart"></canvas>
            </div>

            <div class="card-header-inline">
              <h3 class="card-title">Entradas por conta (mês)</h3>
              <label class="inline-toggle">
                <input id="include-start-entrada" type="checkbox" checked/>
                incluir entrada inicial
              </label>
            </div>
            <div class="chart-wrapper">
              <canvas id="entrada-pie-chart"></canvas>
            </div>

            <h3 class="card-title">Gasto por categoria (mês)</h3>
            <div class="chart-wrapper">
              <canvas id="category-pie-chart"></canvas>
            </div>
          </div>

          <div class="panel-card">
            <h3 class="card-title">Visão geral do mês</h3>
            <div class="yellow-grid">
              <div class="y-row"><span>Crédito (soma disponível)</span><strong id="avail-credit">R$ 0,00</strong></div>
              <div class="y-row"><span>VR (disponível)</span><strong id="avail-vr">R$ 0,00</strong></div>
              <div class="y-row"><span>Saldo</span><strong id="avail-saldo">R$ 0,00</strong></div>
              <div class="y-row"><span>Guardado</span><strong id="avail-guardado">R$ 0,00</strong></div>
            </div>

            <div class="small-box">
              <span>Crédito + débito</span>
              <strong id="credit-debit-small">R$ 0,00</strong>
            </div>

            <h3 class="card-title" style="margin-top:14px">Tendência de gastos (6 meses)</h3>
            <div class="chart-wrapper chart-wrapper-sm">
              <canvas id="monthly-line-chart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- INPUT -->
    <section id="tab-input" class="tab-panel inputs">
      <h2 class="panel-title">Novo lançamento</h2>

      <form id="expense-form" class="form-grid">
        <div class="form-field">
          <label>Data</label>
          <input type="date" id="exp-date" />
        </div>
        <div class="form-field">
          <label>Descrição</label>
          <input type="text" id="exp-desc" placeholder="Ex: mercado, gasolina..."/>
        </div>
        <div class="form-field">
          <label>Valor (R$)</label>
          <input type="number" step="0.01" id="exp-amount" required/>
        </div>
        <div class="form-field">
          <label>Tipo</label>
          <select id="exp-type">
            <option value="saldo">Débito no saldo</option>
            <option value="credito">Gasto no crédito</option>
            <option value="vr">Gasto no VR (Caju)</option>
            <option value="entrada">Entrada</option>
          </select>
        </div>
        <div class="form-field">
          <label>Banco / conta</label>
          <select id="exp-account"></select>
        </div>
        <div class="form-field">
          <label>Categoria</label>
          <select id="exp-category">
            <option value="alimentacao">Alimentação</option>
            <option value="gasolina">Gasolina</option>
            <option value="mercado">Mercado</option>
            <option value="transporte">Transporte</option>
            <option value="lazer">Lazer</option>
            <option value="saude">Saúde</option>
            <option value="assinaturas">Assinaturas</option>
            <option value="investimento">Investimento</option>
            <option value="impressora3d">Impressora3D</option>
            <option value="outros">Outros</option>
          </select>
        </div>
        <div class="form-field">
          <label>Forma</label>
          <input type="text" id="exp-method" placeholder="Cartão, dinheiro..."/>
        </div>
        <div class="form-actions">
          <button class="btn-primary" type="submit">Registrar</button>
        </div>
      </form>

      <hr class="divider"/>

      <h3 class="panel-subtitle">Linhas longas (edição manual)</h3>
      <div id="editable-accounts" class="editable-accounts"></div>

      <div class="actions">
        <button id="save-btn" class="btn">Salvar</button>
        <button id="reset-btn" class="btn danger">Zerar tudo</button>
      </div>
    </section>

    <!-- INÍCIO DO MÊS -->
    <section id="tab-inicio" class="tab-panel inputs">
      <h2 class="panel-title">Início do mês</h2>
      <p class="muted">Defina VR (Caju), entrada inicial do mês e crédito global.</p>

      <div class="monthly-config">
        <div class="month-totals">
          <div class="tot-block">
            <label>VR total (Caju)</label>
            <input id="inicio-vr-total" type="number" step="0.01" />
          </div>
          <div class="tot-block">
            <label>Entrada inicial</label>
            <input id="inicio-entrada-total" type="number" step="0.01" />
          </div>
          <div class="tot-block">
            <label>Crédito global</label>
            <input id="inicio-credit-global" type="number" step="0.01" />
          </div>
        </div>

        <h3 class="panel-subtitle">Créditos por conta</h3>
        <div id="inicio-credits" class="editable-accounts"></div>

        <div class="actions actions-right" style="gap:8px; align-items:center;">
          <button id="apply-salary" class="btn">Aplicar salário</button>
          <button id="apply-card" class="btn">Aplicar cartão (fechar fatura)</button>
          <button id="close-month" class="btn ghost">Fechar mês (avançar)</button>
          <button id="clear-start-month" class="btn ghost">Limpar</button>
        </div>
      </div>
    </section>

    <!-- INVESTIMENTOS -->
    <section id="tab-invest" class="tab-panel panel">
      <h2 class="panel-title">Investimentos / guardado</h2>

      <div class="invest-actions">
        <form id="box-form" class="invest-form">
          <div class="form-row">
            <label>Nome da caixinha</label>
            <input id="box-name" type="text" placeholder="Ex: Reserva, Viagem, Emergência"/>
          </div>
          <div class="form-row">
            <label>Conta</label>
            <select id="box-account"></select>
          </div>
          <div class="form-row">
            <label>Legenda</label>
            <input id="box-desc" type="text" placeholder="Detalhe opcional da caixinha"/>
          </div>
          <div class="form-row form-row-button">
            <button id="box-create" class="btn-primary" type="button">Criar caixinha</button>
          </div>
        </form>
      </div>

      <div class="invest-grid">
        <div class="panel-card">
          <h3 class="card-title">Caixinhas de investimento</h3>
          <div id="invest-boxes" class="box-grid"></div>
        </div>

        <div class="panel-card">
          <h3 class="card-title">Resumo por conta</h3>
          <div class="invest-list" id="invest-list"></div>

          <h3 class="card-title" style="margin-top:10px">Total guardado</h3>
          <div class="yellow-grid">
            <div class="y-row">
              <span>Total</span>
              <strong id="guardado-total">R$ 0,00</strong>
            </div>
          </div>

          <h3 class="card-title" style="margin-top:14px">Log de guardado</h3>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Data</th>
                  <th>Conta</th>
                  <th>Ação</th>
                  <th>Valor</th>
                  <th>Descrição</th>
                </tr>
              </thead>
              <tbody id="invest-log-body"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- LOG -->
    <section id="tab-log" class="tab-panel inputs">
      <h2 class="panel-title">Log de lançamentos</h2>

      <div class="backup-controls">
        <button id="backup-export" class="btn">Exportar backup</button>
        <label for="backup-import-input" class="btn ghost">Importar backup</label>
        <input id="backup-import-input" type="file" accept="application/json"/>
      </div>

      <div class="log-controls">
        <div class="log-filter">
          <label>Conta</label>
          <select id="log-account-filter">
            <option value="all">Todas</option>
          </select>
        </div>
        <div class="log-filter">
          <label>Apenas mês ativo</label>
          <input id="log-show-only-month" type="checkbox" checked />
        </div>
      </div>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Data</th>
              <th>Descrição</th>
              <th>Conta</th>
              <th>Tipo</th>
              <th>Categoria</th>
              <th>Valor</th>
              <th>Forma</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="log-body"></tbody>
        </table>
      </div>
    </section>

    <!-- IMPRESSORA3D -->
    <section id="tab-imp3d" class="tab-panel panel">
      <h2 class="panel-title">Impressora 3D — Estoque & Produtos</h2>

      <div class="panel-grid">
        <!-- left: filamento + produtos -->
        <div class="panel-card">
          <h3 class="card-title">Estoque de filamentos</h3>
          <p class="panel-subtitle">Adicione filamentos (cor, tipo, peso em gramas e preço em R$). Estes são usados ao vender produtos.</p>

          <div class="form-grid" style="margin-top:8px;">
            <div class="form-field">
              <label>Cor</label>
              <input id="fil-color" type="text" placeholder="Ex: Preto, Branco, Azul..."/>
            </div>
            <div class="form-field">
              <label>Tipo</label>
              <input id="fil-type" type="text" placeholder="Ex: PLA, PETG, ABS..."/>
            </div>
            <div class="form-field">
              <label>Peso (g)</label>
              <input id="fil-weight" type="number" step="0.01" placeholder="Quantidade em gramas"/>
            </div>
            <div class="form-field">
              <label>Preço (R$) — preço total do rolo</label>
              <input id="fil-price" type="number" step="0.01" placeholder="Preço do filamento (R$)"/>
            </div>
            <div class="form-actions">
              <button id="fil-add" class="btn-primary" type="button">Adicionar ao estoque</button>
            </div>
          </div>

          <h4 style="margin-top:12px">Lista de filamentos</h4>
          <div id="filaments-list" style="margin-top:8px"></div>

          <hr class="divider"/>

          <h3 class="card-title">Produtos (cadastro)</h3>
          <p class="panel-subtitle">Ao cadastrar o produto, informe horas de impressão, filamento por unidade (g), custo de energia/h e custo de embalagem.</p>
          <div class="form-grid" style="margin-top:8px;">
            <div class="form-field">
              <label>Nome do produto</label>
              <input id="prod-name" type="text" placeholder="Ex: Miniatura A"/>
            </div>
            <div class="form-field">
              <label>Horas de impressão</label>
              <input id="prod-hours" type="number" step="0.1" placeholder="Horas"/>
            </div>
            <div class="form-field">
              <label>Filamento por unidade (g)</label>
              <input id="prod-fil-g" type="number" step="0.01" placeholder="Gramas por peça"/>
            </div>
            <div class="form-field">
              <label>Custo energia (R$/h)</label>
              <input id="prod-energy-h" type="number" step="0.01" placeholder="Custo por hora (R$)"/>
            </div>
            <div class="form-field">
              <label>Custo embalagem (R$)</label>
              <input id="prod-pack" type="number" step="0.01" placeholder="Custo embal. por unidade"/>
            </div>
            <div class="form-field">
              <label>Preço de venda (R$)</label>
              <input id="prod-price" type="number" step="0.01" placeholder="Preço de venda"/>
            </div>
            <div class="form-field" style="grid-column:1/-1">
              <label>Descrição (opcional)</label>
              <input id="prod-desc" type="text" placeholder="Detalhes do produto"/>
            </div>
            <div class="form-actions" style="grid-column:1/-1">
              <button id="prod-add" class="btn-primary" type="button">Cadastrar produto</button>
            </div>
          </div>

          <h4 style="margin-top:12px">Produtos cadastrados</h4>
          <div id="prod-list" style="margin-top:8px"></div>
        </div>

        <!-- right: resumo and logs -->
        <div class="panel-card">
          <h3 class="card-title">Resumo Impressora3D</h3>
          <div class="yellow-grid" style="margin-top:8px">
            <div class="y-row"><span>Total filamentos (g)</span><strong id="imp3d-total-fil">0 g</strong></div>
            <div class="y-row"><span>Produtos cadastrados</span><strong id="imp3d-count-prod">0</strong></div>
            <div class="y-row"><span>Conta imp3d</span><strong id="imp3d-acc-balance">—</strong></div>
            <div class="y-row"><span>Conta Shopee</span><strong id="shopee-acc-balance">—</strong></div>
          </div>

          <h3 class="card-title" style="margin-top:12px">Log de vendas (Impressora3D)</h3>
          <div class="table-wrapper" style="max-height:200px">
            <table>
              <thead>
                <tr>
                  <th>Data</th>
                  <th>Produto</th>
                  <th>Filamento</th>
                  <th>Qtd</th>
                  <th>Valor</th>
                </tr>
              </thead>
              <tbody id="imp3d-sales-body"></tbody>
            </table>
          </div>

          <h3 class="card-title" style="margin-top:12px">Perdas / retiradas de filamento</h3>
          <div class="table-wrapper" style="max-height:200px">
            <table>
              <thead>
                <tr>
                  <th>Data</th>
                  <th>Filamento</th>
                  <th>g</th>
                  <th>Custo (R$)</th>
                  <th>Motivo</th>
                </tr>
              </thead>
              <tbody id="imp3d-losses-body"></tbody>
            </table>
          </div>

          <h3 class="card-title" style="margin-top:12px">Ações rápidas</h3>
          <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
            <button id="imp3d-export" class="btn">Exportar backup Impressora3D</button>
            <button id="imp3d-clear" class="btn ghost">Limpar tudo Impressora3D</button>
            <button id="sh-to-nb" class="btn">Transferir Shopee → Nubank</button>
          </div>
        </div>
      </div>
    </section>

  </main>

  <footer class="foot">
    <small>Dados salvos no navegador (localStorage).</small>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.pluggy.ai/pluggy-connect/v2.7.0/pluggy-connect.js"></script>
  <script src="script.js?v=7"></script>
  <script src="sync-pluggy-ui.js?v=7"></script>

  <!-- Script auxiliar: observa formulários de venda dinamicamente e injeta / atualiza painel de pré-cálculo -->
  <script>
    (function(){
      // Observe o container da Impressora3D para detectar formulários de venda gerados dinamicamente
      const container = document.getElementById('tab-imp3d');
      if(!container) return;

      const mo = new MutationObserver(mutations=>{
        for(const m of mutations){
          for(const n of m.addedNodes){
            if(n.nodeType !== 1) continue;
            if(n.id && n.id.startsWith('imp3d-sell-form-')){
              enhanceSellForm(n);
            }
          }
        }
      });

      mo.observe(container, { childList: true, subtree: true });

      // Função para criar painel de preview dentro do form e ligar listeners
      function enhanceSellForm(formEl){
        if(formEl._enhanced) return;
        formEl._enhanced = true;

        // criar painel de preview
        const preview = document.createElement('div');
        preview.className = 'imp3d-sell-preview';
        preview.innerHTML = `
          <div><span class="label">Custo material (total)</span><span class="value" id="${formEl.id}-mat">R$ 0,00</span></div>
          <div><span class="label">Taxa plataforma (total)</span><span class="value" id="${formEl.id}-fee">R$ 0,00</span></div>
          <div><span class="label">Recebido líquido</span><span class="value" id="${formEl.id}-net">R$ 0,00</span></div>
          <div><span class="label">Lucro estimado</span><span class="value" id="${formEl.id}-profit">R$ 0,00</span></div>
        `;
        formEl.appendChild(preview);

        // helper: pega ids/inputs dentro do form
        function ids(){
          const pid = formEl.id.replace('imp3d-sell-form-','');
          const filSel = formEl.querySelector(`#sell-fil-${pid}`);
          const qtyInput = formEl.querySelector(`#sell-qty-${pid}`);
          const priceInput = formEl.querySelector(`#sell-price-${pid}`);
          return { pid, filSel, qtyInput, priceInput };
        }

        function fmt(v){ return (typeof money === 'function') ? money(v) : ('R$ ' + Number(v||0).toFixed(2)); }

        function recompute(){
          const { pid, filSel, qtyInput, priceInput } = ids();
          if(!window.state || !window.SHOPEE_FEE_FIXED || !window.SHOPEE_FEE_PCT) {
            // se script.js ainda não inicializou variáveis, tentar usar defaults
          }
          const prod = window.state && window.state.products && window.state.products.find(p=>p.id===pid);
          const fil = window.state && window.state.filaments && window.state.filaments.find(f=>f.id === (filSel ? filSel.value : null));
          const qty = Number(qtyInput ? qtyInput.value || 0 : 0);
          const price = Number(priceInput ? priceInput.value || 0 : (prod ? prod.price : 0));
          if(!prod || !fil || qty <= 0 || price <= 0){
            // zera preview
            preview.querySelector(`#${formEl.id}-mat`).textContent = fmt(0);
            preview.querySelector(`#${formEl.id}-fee`).textContent = fmt(0);
            preview.querySelector(`#${formEl.id}-net`).textContent = fmt(0);
            preview.querySelector(`#${formEl.id}-profit`).textContent = fmt(0);
            return;
          }

          // calcular custo material baseado no initialWeight/price do rolo (mesma lógica do script.js)
          const initial = Number(fil.initialWeight || fil.weight || 0);
          const priceRolo = Number(fil.price || 0);
          const pricePerGram = (initial > 0) ? (priceRolo / initial) : 0;
          const matPerUnit = Number(prod.fil_g || 0);
          const materialCostTotal = pricePerGram * matPerUnit * qty;

          // taxa Shopee (usa constantes definidas em script.js)
          const FEE_FIXED = (typeof SHOPEE_FEE_FIXED !== 'undefined') ? SHOPEE_FEE_FIXED : 4.00;
          const FEE_PCT = (typeof SHOPEE_FEE_PCT !== 'undefined') ? SHOPEE_FEE_PCT : 0.20;
          const feePerUnit = Number(FEE_FIXED) + Number(FEE_PCT) * Number(price || 0);
          const feeTotal = feePerUnit * qty;

          const gross = Number(price) * qty;
          const net = gross - feeTotal;
          // incluir energia + embalagem se o produto tiver esses campos no cadastro (se houver)
          let energyCost = 0, packCost = 0;
          if(prod){
            const energyPerUnit = Number(prod.hours || 0) * (Number(prod.energy_h || prod.energy || 0) || 0);
            energyCost = energyPerUnit * 1; // já por unidade
            packCost = Number(prod.pack || prod.pack_cost || 0);
          }
          // Note: seu script principal não somou energia/embalagem no profit; aqui mostramos profit sem energia/embalagem por padrão,
          // mas se existir os campos, subtraímos.
          const profit = net - materialCostTotal - (energyCost + packCost) * qty;

          preview.querySelector(`#${formEl.id}-mat`).textContent = fmt(materialCostTotal);
          preview.querySelector(`#${formEl.id}-fee`).textContent = fmt(feeTotal);
          preview.querySelector(`#${formEl.id}-net`).textContent = fmt(net);
          preview.querySelector(`#${formEl.id}-profit`).textContent = fmt(profit);
        }

        // att listeners para recalcular quando campos mudam
        formEl.addEventListener('change', recompute);
        formEl.addEventListener('input', recompute);

        // recompute inicial (caso já tenham valores)
        setTimeout(recompute, 120);
      }

      // caso já exista formulários ao abrir (raro), enhance-os
      document.querySelectorAll('[id^="imp3d-sell-form-"]').forEach(n=> enhanceSellForm(n));
    })();
  </script>
</body>
</html>
